# API文档

本文档详细列出了维修项目管理系统提供的所有API端点。

## 基础URL

所有API端点都以`/api`为前缀。例如，完整的登录API URL是`http://localhost:8000/api/auth/token`。

服务器地址可以在前端配置中设置，默认为`http://xin.work.gd:8000`。

## 认证

除了登录、注册API和健康检查API外，所有API都需要认证。认证使用JWT令牌，需要在HTTP请求头中添加`Authorization`字段：

```
Authorization: Bearer {token}
```

其中`{token}`是通过登录API获取的访问令牌。

## 基础API

### 根端点

- **URL**: `/`
- **方法**: `GET`
- **描述**: 返回API服务器欢迎信息
- **响应**:
  ```json
  {
    "message": "欢迎使用维修项目管理系统API"
  }
  ```

### 健康检查

- **URL**: `/api/health`
- **方法**: `GET`
- **描述**: 简单的健康检查端点
- **响应**:
  ```json
  {
    "status": "healthy"
  }
  ```

## 认证相关API

### 用户登录

- **URL**: `/api/auth/token`
- **方法**: `POST`
- **描述**: 用户登录，获取访问令牌
- **请求体**:
  ```json
  {
    "username": "admin",
    "password": "admin123"
  }
  ```
- **响应**:
  ```json
  {
    "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "token_type": "bearer"
  }
  ```

### 用户注册

- **URL**: `/api/auth/register`
- **方法**: `POST`
- **描述**: 用户注册
- **请求体**:
  ```json
  {
    "username": "newuser",
    "password": "password123",
    "email": "user@example.com",
    "full_name": "New User",
    "phone": "13800000000",
    "role": "worker"
  }
  ```
- **响应**:
  ```json
  {
    "id": 1,
    "username": "newuser",
    "email": "user@example.com",
    "full_name": "New User",
    "phone": "13800000000",
    "role": "worker",
    "is_active": true
  }
  ```

### 获取当前用户信息

- **URL**: `/api/auth/me`
- **方法**: `GET`
- **描述**: 获取当前用户信息
- **响应**:
  ```json
  {
    "id": 1,
    "username": "admin",
    "email": "admin@example.com",
    "full_name": "Admin User",
    "phone": "13800000000",
    "role": "admin",
    "is_active": true
  }
  ```

## 维修项目API

### 获取项目列表

- **URL**: `/api/projects/`
- **方法**: `GET`
- **描述**: 获取项目列表
- **查询参数**:
  - `skip`: 跳过的记录数（默认0）
  - `limit`: 返回的记录数（默认100）
  - `status`: 项目状态筛选
- **响应**: 项目列表

### 创建新项目

- **URL**: `/api/projects/`
- **方法**: `POST`
- **描述**: 创建新项目
- **请求体**: 项目信息
- **响应**: 创建的项目信息

### 获取项目详情

- **URL**: `/api/projects/{id}`
- **方法**: `GET`
- **描述**: 获取项目详情
- **响应**: 项目详细信息

### 更新项目信息

- **URL**: `/api/projects/{id}`
- **方法**: `PUT`
- **描述**: 更新项目信息
- **请求体**: 更新的项目信息
- **响应**: 更新后的项目信息

### 删除项目

- **URL**: `/api/projects/{id}`
- **方法**: `DELETE`
- **描述**: 删除项目
- **响应**: 无内容（204）

## 工单管理API

### 获取工单列表

- **URL**: `/api/tasks/`
- **方法**: `GET`
- **描述**: 获取工单列表
- **查询参数**:
  - `skip`: 跳过的记录数（默认0）
  - `limit`: 返回的记录数（默认100）
  - `status`: 工单状态筛选
  - `project_id`: 项目ID筛选
- **响应**: 工单列表

### 获取我的工单

- **URL**: `/api/tasks/my-tasks`
- **方法**: `GET`
- **描述**: 获取分配给当前用户的工单列表
- **查询参数**:
  - `skip`: 跳过的记录数（默认0）
  - `limit`: 返回的记录数（默认100）
  - `status`: 工单状态筛选
- **响应**: 工单列表

### 创建新工单

- **URL**: `/api/tasks/`
- **方法**: `POST`
- **描述**: 创建新工单
- **请求体**: 工单信息
- **响应**: 创建的工单信息

### 获取工单详情

- **URL**: `/api/tasks/{id}`
- **方法**: `GET`
- **描述**: 获取工单详情
- **响应**: 工单详细信息

### 更新工单信息

- **URL**: `/api/tasks/{id}`
- **方法**: `PUT`
- **描述**: 更新工单信息
- **请求体**: 更新的工单信息
- **响应**: 更新后的工单信息

### 分配工单

- **URL**: `/api/tasks/{id}/assign`
- **方法**: `POST`
- **描述**: 分配工单
- **请求体**:
  ```json
  {
    "assigned_to_id": 2
  }
  ```
- **响应**: 更新后的工单信息

### 完成工单

- **URL**: `/api/tasks/{id}/complete`
- **方法**: `POST`
- **描述**: 完成工单
- **请求体**: 完成工单的信息，包括材料和工作内容
- **响应**: 更新后的工单信息

### 批量导入工单

- **URL**: `/api/tasks/import`
- **方法**: `POST`
- **描述**: 批量导入工单
- **请求体**: 表单数据，包含CSV文件
- **响应**: 导入结果信息

## 材料管理API

### 获取材料分类列表

- **URL**: `/api/materials/categories`
- **方法**: `GET`
- **描述**: 获取所有材料分类
- **响应**: 材料分类列表

### 获取材料供应类型列表

- **URL**: `/api/materials/supply-types`
- **方法**: `GET`
- **描述**: 获取所有供应类型
- **响应**: 供应类型列表

### 获取材料列表

- **URL**: `/api/materials/`
- **方法**: `GET`
- **描述**: 获取材料列表
- **查询参数**:
  - `skip`: 跳过的记录数（默认0）
  - `limit`: 返回的记录数（默认100）
  - `category`: 材料分类筛选
  - `code`: 材料编号筛选
  - `name`: 材料名称筛选
  - `supply_type`: 供应类型筛选
  - `is_active`: 是否启用筛选
- **响应**: 材料列表

### 创建新材料

- **URL**: `/api/materials/`
- **方法**: `POST`
- **描述**: 创建新材料
- **请求体**: 材料信息
- **响应**: 创建的材料信息

### 更新材料信息

- **URL**: `/api/materials/{id}`
- **方法**: `PUT`
- **描述**: 更新材料信息
- **请求体**: 更新的材料信息
- **响应**: 更新后的材料信息

### 删除材料

- **URL**: `/api/materials/{id}`
- **方法**: `DELETE`
- **描述**: 删除材料
- **响应**: 无内容（204）

### 批量导入材料

- **URL**: `/api/materials/import`
- **方法**: `POST`
- **描述**: 批量导入材料
- **请求体**: 表单数据，包含CSV文件
- **响应**: 导入结果信息

## 工作内容管理API

### 获取工作内容分类列表

- **URL**: `/api/work-items/categories`
- **方法**: `GET`
- **描述**: 获取所有工作内容分类
- **响应**: 工作内容分类列表

### 获取工作内容列表

- **URL**: `/api/work-items/`
- **方法**: `GET`
- **描述**: 获取工作内容列表
- **查询参数**:
  - `skip`: 跳过的记录数（默认0）
  - `limit`: 返回的记录数（默认100）
  - `category`: 项目分类筛选
  - `project_number`: 项目编号筛选
  - `name`: 工作项名称筛选
  - `is_active`: 是否启用筛选
- **响应**: 工作内容列表

### 创建新工作内容

- **URL**: `/api/work-items/`
- **方法**: `POST`
- **描述**: 创建新工作内容
- **请求体**: 工作内容信息
- **响应**: 创建的工作内容信息

### 更新工作内容

- **URL**: `/api/work-items/{id}`
- **方法**: `PUT`
- **描述**: 更新工作内容
- **请求体**: 更新的工作内容信息
- **响应**: 更新后的工作内容信息

### 删除工作内容

- **URL**: `/api/work-items/{id}`
- **方法**: `DELETE`
- **描述**: 删除工作内容
- **响应**: 无内容（204）

### 批量导入工作内容

- **URL**: `/api/work-items/import`
- **方法**: `POST`
- **描述**: 批量导入工作内容
- **请求体**: 表单数据，包含CSV文件
- **响应**: 导入结果信息

## 施工队伍管理API

### 获取队伍列表

- **URL**: `/api/teams/`
- **方法**: `GET`
- **描述**: 获取队伍列表
- **查询参数**:
  - `skip`: 跳过的记录数（默认0）
  - `limit`: 返回的记录数（默认100）
  - `is_active`: 是否启用筛选
- **响应**: 队伍列表

### 创建新队伍

- **URL**: `/api/teams/`
- **方法**: `POST`
- **描述**: 创建新队伍
- **请求体**: 队伍信息
- **响应**: 创建的队伍信息

### 获取队伍详情

- **URL**: `/api/teams/{id}`
- **方法**: `GET`
- **描述**: 获取队伍详情
- **响应**: 队伍详细信息

### 更新队伍信息

- **URL**: `/api/teams/{id}`
- **方法**: `PUT`
- **描述**: 更新队伍信息
- **请求体**: 更新的队伍信息
- **响应**: 更新后的队伍信息

### 添加队伍成员

- **URL**: `/api/teams/{id}/members`
- **方法**: `POST`
- **描述**: 添加队伍成员
- **请求体**:
  ```json
  {
    "user_id": 2
  }
  ```
- **响应**: 更新后的队伍信息

### 移除队伍成员

- **URL**: `/api/teams/{id}/members/{member_id}`
- **方法**: `DELETE`
- **描述**: 移除队伍成员
- **响应**: 无内容（204）

## 用户管理API

### 获取用户列表

- **URL**: `/api/users/`
- **方法**: `GET`
- **描述**: 获取用户列表
- **查询参数**:
  - `role`: 角色筛选
  - `is_active`: 是否启用筛选
- **响应**: 用户列表

### 获取用户详情

- **URL**: `/api/users/{id}`
- **方法**: `GET`
- **描述**: 获取用户详情
- **响应**: 用户详细信息

### 更新用户信息

- **URL**: `/api/users/{id}`
- **方法**: `PUT`
- **描述**: 更新用户信息
- **请求体**: 更新的用户信息
- **响应**: 更新后的用户信息

### 删除用户

- **URL**: `/api/users/{id}`
- **方法**: `DELETE`
- **描述**: 删除用户
- **响应**: 无内容（204）

### 批量导入用户

- **URL**: `/api/users/import`
- **方法**: `POST`
- **描述**: 批量导入用户
- **请求体**: 表单数据，包含CSV文件
- **响应**: 导入结果信息

## 统计分析API

### 项目统计

- **URL**: `/api/statistics/projects`
- **方法**: `GET`
- **描述**: 项目统计
- **查询参数**:
  - `start_date`: 开始日期（可选，默认为30天前）
  - `end_date`: 结束日期（可选，默认为当前日期）
- **响应**: 项目统计信息，包括项目总数、已完成项目数、完成率等

### 工单统计

- **URL**: `/api/statistics/tasks`
- **方法**: `GET`
- **描述**: 工单统计
- **查询参数**:
  - `start_date`: 开始日期（可选，默认为30天前）
  - `end_date`: 结束日期（可选，默认为当前日期）
- **响应**: 工单统计信息，包括工单总数、已完成工单数、完成率等

### 材料使用统计

- **URL**: `/api/statistics/materials`
- **方法**: `GET`
- **描述**: 材料使用统计
- **查询参数**:
  - `start_date`: 开始日期（可选，默认为30天前）
  - `end_date`: 结束日期（可选，默认为当前日期）
- **响应**: 材料使用统计信息，包括材料总费用、公司提供材料费用、自购材料费用、最常用材料列表等

### 工作内容统计

- **URL**: `/api/statistics/work-items`
- **方法**: `GET`
- **描述**: 工作内容统计
- **查询参数**:
  - `start_date`: 开始日期（可选，默认为30天前）
  - `end_date`: 结束日期（可选，默认为当前日期）
- **响应**: 工作内容统计信息，包括工作内容总费用、最常执行的工作内容列表等

### 队伍绩效统计

- **URL**: `/api/statistics/teams`
- **方法**: `GET`
- **描述**: 队伍绩效统计
- **查询参数**:
  - `start_date`: 开始日期（可选，默认为30天前）
  - `end_date`: 结束日期（可选，默认为当前日期）
- **响应**: 队伍绩效统计信息

## 健康检查API

### 基础健康检查

- **URL**: `/api/health-check/`
- **方法**: `GET`
- **描述**: 检查API服务器是否正常运行，不需要认证
- **响应**:
  ```json
  {
    "status": "ok",
    "message": "API服务器运行正常"
  }
  ```

### 认证健康检查

- **URL**: `/api/health-check/auth`
- **方法**: `GET`
- **描述**: 检查认证是否正常，需要认证
- **响应**:
  ```json
  {
    "status": "ok",
    "message": "认证正常",
    "user_id": 1,
    "username": "admin"
  }
  ```

## 文件上传API

### 上传单个文件

- **URL**: `/api/upload/`
- **方法**: `POST`
- **描述**: 上传单个文件
- **请求体**: 表单数据，包含文件
- **响应**:
  ```json
  {
    "filename": "example.jpg",
    "url": "/uploads/20230101/uuid-filename.jpg",
    "size": 12345,
    "content_type": "image/jpeg"
  }
  ```

### 上传多个文件

- **URL**: `/api/upload/multiple`
- **方法**: `POST`
- **描述**: 上传多个文件
- **请求体**: 表单数据，包含多个文件
- **响应**: 上传结果列表，每个文件的信息与单文件上传响应相同
